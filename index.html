<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Presupuesto v2.0</title>
    <style>
        /* --- ESTILOS INICIALES DEL PRESUPUESTO --- */
        @media print {
            .ocultar-al-imprimir-botones {
                display: none;
            }

        }

        img {
            height: 8pt;
            display: initial;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
        }

        .invoice-container {
            /*background-image: url(./Base.jpg);*/
            background-color: #fff;
            background-size: contain;
            width: 21cm;
            height: 29.7cm;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            color: #000;
            padding: 0cm 0cm;
            box-sizing: border-box;
            line-height: 1.5;
            font-size: 10pt;
            display: flex;
            flex-direction: column;
        }

        .Contenido {
            margin: 0 1.3cm;
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            width: 100%;
            height: 4.2cm;
            background: url('/Banner.jpg') left/cover no-repeat;
        }

        .header-info {
            text-align: right;
            line-height: 1.3;
            font-size: 10pt;
            font-family: 'Roboto Mono', monospace;
            font-weight: 700;
            color: #fff;
            margin: auto 1cm;
        }

        .header-info div:first-child {
            font-size: 10pt;
            margin-bottom: 5px;
        }

        /* DATE INPUT */
        .date-input {
            border: none;
            background: none;
            text-align: right;
            font-family: 'Roboto Mono', monospace;
            font-weight: 700;
            color: #fff;
            font-size: 12pt;
            outline: none;
            cursor: default;
            padding: 0;
            margin-right: 0cm;
            line-height: 1.3;
            height: 19pt;
            width: 3.5cm;
            box-sizing: border-box;
        }

        .date-input:focus {
            border: 1px dashed #fff;
            padding: 1px;
            background-color: rgba(255, 255, 255, 0.2);
            width: 3.6cm;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            /*display: none;*/
        }


        /* TITLE SECTION */
        .title-section {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 30px;
            padding-top: 10px;
        }

        .title-section h1 {
            font-family: 'Oswald', sans-serif;
            font-size: 32pt;
            font-weight: 500;
            margin: 0;
            letter-spacing: 2px;
        }

        .title-section .num {
            font-family: 'Roboto Mono', monospace;
            font-size: 12pt;
            color: #555;
            margin-bottom: 10px;
        }

        /* CLIENT/PROJECT SUMMARY */
        .summary {
            display: flex;
            margin-bottom: 20px;
            gap: 70px;
            padding-bottom: 80px;
            border-bottom: 1px solid #1a1a1a;
        }

        .summary-block {
            line-height: 0.8;
        }

        .summary-block strong {
            font-weight: bold;
            font-size: 12pt;
            display: block;
            margin-bottom: 5px;
        }

        .summary-block span {
            color: #555;
        }

        /* ITEMS TABLE */
        .Lista {
            margin-left: 180px;
            margin-top: -50px;
            height: 400px;
        }

        .items-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .items-header .detail-col {
            width: 60%;
        }

        .items-header .cost-col {
            width: 30%;
            text-align: center;
        }

        .item-group {
            margin-bottom: 20px;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .item-row.main {
            font-weight: bold;
        }

        .item-row.sub {
            font-size: 9pt;
            color: #555;
            display: flex;
            width: 100%;
        }

        .item-row .detail {
            width: 50%;
        }

        .item-row .cost {
            width: 20%;
            text-align: right;
        }

        /* CONDITIONS, TOTAL, PAYMENT */
        .footer {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
        }

        .conditions-block {
            width: 50%;
            font-size: 8pt;
            line-height: 1.4;
            color: #333;
        }

        .conditions-block strong {
            display: block;
            font-size: 10pt;
            margin-bottom: 10px;
            color: #1a1a1a;
        }

        .conditions-block ol {
            padding-left: 15px;
            margin: 0;
        }

        .conditions-block li {
            margin-bottom: 10px;
        }

        .financial-block {
            width: 40%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .total-box {
            text-align: center;
        }

        .total-row {
            border-top: 1px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: baseline;
            margin-bottom: 10px;
        }

        .total-row .label {
            font-size: 14pt;
            font-weight: bold;
            margin-right: 15px;
            letter-spacing: 1px;
        }

        .total-row .amount {
            font-family: 'Roboto Mono', monospace;
            font-size: 20pt;
            font-weight: 700;
            color: #1a1a1a;
        }

        .delivery-time .amount {
            font-family: 'Roboto Mono', monospace;
            font-size: 15pt;
            font-weight: 700;
            color: #1a1a1a;
        }


        .ars {
            font-size: 10pt;
            font-weight: normal;
            vertical-align: top;
            margin-left: 5px;
            color: #555;
        }

        .ars2 {
            font-size: 7pt;
            font-weight: normal;
            vertical-align: top;
            margin-left: 5px;
            color: #555;
        }

        .delivery-time {
            text-align: center;
            font-size: 10pt;
            margin-top: -10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
        }

        .delivery-time strong {
            font-weight: bold;
        }

        .payment-methods {
            font-size: 9pt;
            line-height: 1.6;
            text-align: center;

        }

        .payment-methods strong {
            font-weight: bold;
            display: block;
            font-size: 10pt;
            margin-bottom: 5px;
        }

        /* FOOTER CONTACT */
        .contact {
            margin-top: 10px;
            padding-top: 20px;
            border-top: 1px solid #1a1a1a;
            text-align: center;
            font-size: 8pt;
            display: flex;
            justify-content: right;
            gap: 20px;
            border-collapse: collapse;
        }

        a {
            color: #000;
            text-decoration: none;
        }

        ul {
            list-style: '> ';
            padding-left: 15px;
            margin: 0;
        }

        /* Added for editing visualization */
        [contenteditable="true"] {
            border: 1px dashed #ccc;
            padding: 2px;
            outline: none;
        }

        .controls {
            margin-top: 5px;
            margin-right: 0px;
            text-align: center;
        }

        .controls button {
            padding: 8px 15px;
            margin: 5px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
        }

        #editButton {
            background-color: #007bff;
            color: white;
        }

        #addItemButton {
            background-color: #28a745;
            color: white;
        }

        #printButton {
            background-color: #696969;
            color: white;
        }

        .delete-item-btn {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 12pt;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
            margin-left: 10px;
            visibility: hidden;
        }

        /* Ensure .detail and .cost take up space */
        .item-row.sub .detail {
            flex-grow: 1;
            min-width: 50%;
        }

        .item-row.sub .cost {
            width: 50px;
        }

        #items-ul li:nth-child(odd) {
            background-color: #eee;
            border-radius: 5px;
            padding: 0px 10px;
        }

        #items-ul li:nth-child(even) {
            background-color: #fff;
            border-radius: 5px;
            padding: 0px 10px;
        }

        /* --- ESTILOS DEL FORMULARIO PREVIO --- */
        .hidden {
            display: none !important;
        }

        #formulario-previo {
            width: 400px;
            padding: 30px;
            margin-top: 50px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #formulario-previo label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            color: #333;
        }
        
        #formulario-previo input[type="text"],
        #formulario-previo input[type="date"],
        #formulario-previo input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        #item-inputs input {
            margin-bottom: 10px;
        }

        #agregar-item-btn,
        #generar-presupuesto-btn {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        #agregar-item-btn {
            background-color: #28a745;
            color: white;
        }

        #agregar-item-btn:hover {
            background-color: #1e7e34;
        }

        #generar-presupuesto-btn {
            background-color: #007bff;
            color: white;
        }

        #generar-presupuesto-btn:hover {
            background-color: #0056b3;
        }
        
        #lista-items-agregados {
            list-style-type: none;
            padding: 0;
            margin-top: 15px;
        }

        #lista-items-agregados li {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            margin-bottom: 5px;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>

<body>
    <div id="formulario-previo">
        <h2>Creaci√≥n R√°pida de Presupuesto</h2>
        <form id="datos-previos-form">
            <div>
                <label for="input-fecha">Fecha del Presupuesto:</label>
                <input type="date" id="input-fecha" required>
            </div>
            <div>
                <label for="input-cliente">Nombre del Cliente:</label>
                <input type="text" id="input-cliente" placeholder="Ej: Juan P√©rez" required>
            </div>
            <div>
                <label for="input-proyecto">Descripci√≥n del Proyecto:</label>
                <input type="text" id="input-proyecto" placeholder="Ej: Dise√±o de Logo" required>
            </div>
            <div>
                <label for="input-numero">N√∫mero de Presupuesto:</label>
                <input type="number" id="input-numero" placeholder="Ej: 001" value="1" required>
            </div>

            <hr>

            <h3>A√±adir √çtems</h3>
            <div id="item-inputs">
                <label for="input-item-detail">Detalle del Item:</label>
                <input type="text" id="input-item-detail" placeholder="Ej: Dise√±o de icono">
                <label for="input-item-cost">Costo (ARS):</label>
                <input type="number" id="input-item-cost" placeholder="Ej: 15000" min="0">
                <button type="button" id="agregar-item-btn">‚ûï Agregar Item a la Lista</button>
            </div>

            <ul id="lista-items-agregados">
                </ul>

            <hr>

            <button type="submit" id="generar-presupuesto-btn">üìù Generar Presupuesto</button>
        </form>
    </div>

    <div class="invoice-container hidden" id="presupuesto-content">
        <div class="header" id="headerContent">
            <div class="logo"></div>
            <div class="header-info">
                <input type="date" id="invoiceDate" class="date-input">
                <div id="companyName">Mat√≠as A. Santoro</div>
                <div id="companyCuit">20-40493208-0</div>
                <div class="controls">
                    <button id="editButton" class="ocultar-al-imprimir-botones" onclick="toggleEdit()">üìù Editar
                        Contenido</button>
                    <button id="printButton" class="ocultar-al-imprimir-botones" onclick="window.print()">üñ® Imprimir
                        Contenido</button>
                </div>
            </div>
        </div>
        <div class="Contenido">
            <div class="title-section">
                <h1>PRESUPUESTO</h1>
                <div class="num">‚Äî NUM. <span id="invoiceNumber">X</span></div>
            </div>

            <div class="summary">
                <div class="summary-block client">
                    <strong>Cliente</strong>
                    <span contenteditable="false" id="cliente-summary"></span>
                </div>
                <div class="summary-block project">
                    <strong>Proyecto</strong>
                    <span contenteditable="false" id="proyecto-summary"></span>
                </div>
            </div>
            <div class="Lista">
                <div class="items-list">
                    <div class="items-header">
                        <div class="detail-col">Detalle</div>
                        <div class="cost-col">Costo / Valor</div>
                    </div>

                    <div class="item-group">
                        <div class="item-row main">
                            <div class="detail" contenteditable="false">Detalles del Proyecto</div>
                            <div class="cost"></div>
                        </div>
                        <ul id="items-ul" class="estilo-tiras">
                            </ul>
                    </div>
                </div>
            </div>
            <div class="controls" style="margin-top: -20px;">
                <button id="addItemButton" onclick="addNewItem()" style="display:none;">‚ûï Agregar Item</button>
            </div>
            <div class="footer">

                <div class="conditions-block">
                    <strong>Condiciones</strong>
                    <ol id="conditions-list">
                        <li>Los archivos finales y/o originales no ser√°n entregados hasta que el pago total sea abonado
                            y
                            confirmado mediante un comprobante.</li>
                        <li>No se permitir√° la reducci√≥n del tiempo del proyecto ni la entrega anticipada. Se respetar√°
                            el
                            plazo de entrega estipulado, salvo casos de fuerza mayor o ajenos a las gestiones.</li>
                        <li>No se efectuar√°n cambios al proyecto y/o archivos luego de su entrega completa en el plazo
                            estipulado. De necesitar modificaciones que no se encuentren dentro de los plazos
                            correspondientes, se armar√° un nuevo presupuesto.</li>
                    </ol>
                </div>

                <div class="financial-block">
                    <div class="total-box">
                        <div class="total-row">
                            <span class="label">TOTAL: </span>
                            <span class="amount" id="totalAmount">$0<span class="ars">ARS</span></span>
                        </div>
                        <div class="delivery-time">
                            <div>Plazo estimado de entrega: <strong contenteditable="false" id="deliveryTime">1
                                    Semana</strong></div>
                            <div>Se√±a del 50%: <strong class="amount" id="depositAmount">$0</strong><span
                                    class="ars2">ARS</span></div>
                        </div>
                    </div>

                    <div class="payment-methods">
                        <strong>M√©todos de Pago:</strong>
                        <div><b>Alias:</b> matias.santoro.mp</div>
                        <div><b>CBU:</b> 0140036603710355419484</div>
                        <div><i><a href="mailto:msantoro85@hotmail.com">(Transferencia Bancaria)</i></>
                        </div>
                    </div>
                </div>
            </div>

            <div class="contact">
                <div><a href="mailto:msantoro.dsg@gmail.com"><img
                            src="./sobre.svg"
                            alt="Correo Electr√≥nico" class="Icono"> msantoro.dsg@gmail.com</a>
                </div>
                <span>|</span>
                <div><a href="https://instagram.com/msantoro.dsg" target="_blank"><img
                            src="./camara.svg" alt="Instagram"
                            class="Icono"> @msantoro.dsg</a>
                </div>
                <span>|</span>
                <div><a href="https://wa.me/+543487366401"><img
                            src="./llamada-telefonica.svg" alt="WhatsApp"
                            class="Icono"></a><a href="tel:+543487366401" alt="Tel√©fono">
                        +54 (34873) 66401</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABLES Y CONFIGURACI√ìN INICIAL ---
        const editableElements = document.querySelectorAll(
            '#invoiceNumber, .summary span, .item-row .detail, .item-row .cost, #deliveryTime'
        );
        const editButton = document.getElementById('editButton');
        const addItemButton = document.getElementById('addItemButton');
        const ul = document.getElementById('items-ul');
        const invoiceDateInput = document.getElementById('invoiceDate');
        let isEditing = false;
        
        // Elementos del nuevo formulario
        const formPrevio = document.getElementById('datos-previos-form');
        const contenedorFormulario = document.getElementById('formulario-previo');
        const contenedorPresupuesto = document.getElementById('presupuesto-content');

        // Variables para la nueva funcionalidad de √≠tems en el formulario previo
        const inputItemDetail = document.getElementById('input-item-detail');
        const inputItemCost = document.getElementById('input-item-cost');
        const agregarItemBtn = document.getElementById('agregar-item-btn');
        const listaItemsAgregados = document.getElementById('lista-items-agregados');
        
        // Array para almacenar los √≠tems agregados antes de generar el presupuesto
        const itemsAgregados = []; 


        document.addEventListener('DOMContentLoaded', () => {
            // Establecer la fecha actual en el input del formulario previo
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('input-fecha').value = today;

            invoiceDateInput.setAttribute('readonly', true);
            updateTotals(); // Inicializa totales (deber√≠a dar $0 al inicio)
        });

        // --- MANEJO DE AGREGAR √çTEMS EN EL FORMULARIO PREVIO ---
        agregarItemBtn.addEventListener('click', () => {
            const detail = inputItemDetail.value.trim();
            // Intenta parsear el costo a un n√∫mero flotante
            const cost = parseFloat(inputItemCost.value);

            if (detail && !isNaN(cost) && cost >= 0) {
                // Agregar al array interno
                itemsAgregados.push({ detail, cost });

                // Mostrar el √≠tem en la lista temporal
                const li = document.createElement('li');
                const costFormatted = cost.toLocaleString('es-AR', { minimumFractionDigits: 0 });
                li.innerHTML = `<span>${detail}</span> - <strong>$${costFormatted}</strong>`;
                listaItemsAgregados.appendChild(li);

                // Limpiar inputs y enfocar
                inputItemDetail.value = '';
                inputItemCost.value = '';
                inputItemDetail.focus();
            } else {
                alert('Por favor, ingresa un detalle v√°lido y un costo num√©rico mayor o igual a cero.');
            }
        });


        // --- MANEJO DEL SUBMIT DEL FORMULARIO PREVIO ---
        formPrevio.addEventListener('submit', (e) => {
            e.preventDefault();

            if (itemsAgregados.length === 0) {
                alert('Debes agregar al menos un item al presupuesto antes de generarlo.');
                return;
            }

            // 1. Recoger datos
            const fecha = document.getElementById('input-fecha').value;
            const cliente = document.getElementById('input-cliente').value;
            const proyecto = document.getElementById('input-proyecto').value;
            const numero = document.getElementById('input-numero').value;

            // 2. Poblar el Presupuesto
            invoiceDateInput.value = fecha;
            document.getElementById('cliente-summary').textContent = cliente;
            document.getElementById('proyecto-summary').textContent = proyecto;
            document.getElementById('invoiceNumber').textContent = numero.padStart(3, '0'); // Formatea el n√∫mero a 3 d√≠gitos

            // 3. Poblar la lista de √çtems
            const itemsUl = document.getElementById('items-ul');
            itemsUl.innerHTML = ''; // Limpiar cualquier contenido inicial

            itemsAgregados.forEach(item => {
                const newLi = document.createElement('li');
                const costFormatted = item.cost.toLocaleString('es-AR', { minimumFractionDigits: 0 });
                
                newLi.innerHTML = `
                    <div class="item-row sub">
                        <div class="detail" contenteditable="false">${item.detail}</div>
                        <button class="delete-item-btn" onclick="removeItem(this)">‚ùå</button>
                        <div class="cost" contenteditable="false" onblur="updateTotals()">$${costFormatted}</div>
                    </div>
                `;
                itemsUl.appendChild(newLi);
            });


            // 4. Ocultar el formulario y mostrar el presupuesto
            contenedorFormulario.classList.add('hidden');
            contenedorPresupuesto.classList.remove('hidden');
            
            // 5. Recalcular totales con los nuevos √≠tems
            updateTotals();
        });


        /**
         * Toggles contentEditable attribute for all marked elements and shows/hides control buttons.
         */
        function toggleEdit() {
            isEditing = !isEditing;

            editableElements.forEach(el => {
                // The item-row .detail and .cost cells are handled separately when adding a new item
                if (el.classList.contains('detail') || el.classList.contains('cost')) {
                    // Only sub-item details and costs should be toggled
                    if (el.closest('.item-row') && el.closest('.item-row').classList.contains('sub')) {
                        el.contentEditable = isEditing;
                    }
                } else {
                    el.contentEditable = isEditing;
                }
            });

            // Specific handling for the date input's readonly attribute
            if (isEditing) {
                invoiceDateInput.removeAttribute('readonly');
                invoiceDateInput.style.pointerEvents = 'auto';

                editButton.textContent = 'üíæ Guardar Cambios';
                editButton.style.backgroundColor = '#dc3545';
                addItemButton.style.display = 'inline-block';

            } else {
                invoiceDateInput.setAttribute('readonly', true);
                invoiceDateInput.style.pointerEvents = 'none';

                editButton.textContent = 'üìù Editar Contenido';
                editButton.style.backgroundColor = '#007bff';
                addItemButton.style.display = 'none';

                updateTotals(); // Recalculate totals after saving
            }

            // Toggle item delete buttons visibility
            document.querySelectorAll('.delete-item-btn').forEach(btn => {
                btn.style.visibility = isEditing ? 'visible' : 'hidden';
            });

            // Selecciona todos los elementos que tengan el atributo contenteditable
            let elements = document.querySelectorAll('[contenteditable]');

            // Itera sobre cada elemento seleccionado
            elements.forEach(function (element) {
                // Establece el valor del atributo contenteditable a 'false'
                element.setAttribute('contenteditable', isEditing ? 'true' : 'false');
            });

        }

        /**
         * Agrega un nuevo elemento de lista al presupuesto (usado desde el bot√≥n en el presupuesto).
         */
        function addNewItem() {
            const newLi = document.createElement('li');
            newLi.innerHTML = `
                <div class="item-row sub">
                    <div class="detail" contenteditable="true" onclick="finishEditing(this)">Nuevo Item (Descripci√≥n)</div>
                    <button class="delete-item-btn" onclick="removeItem(this)">‚ùå</button>
                    <div class="cost" contenteditable="true" onblur="finishEditing(this)">$ 0</div>
                </div>
            `;
            if (isEditing) {
                newLi.querySelectorAll('.delete-item-btn').forEach(btn => btn.style.visibility = 'visible');
            }
            ul.appendChild(newLi);
            newLi.querySelector('.detail').focus();
            updateTotals();
        }

        /**
         * Removes a specific item when its individual delete button is clicked.
         * @param {HTMLElement} button - The clicked delete button element.
         */
        function removeItem(button) {
            const li = button.closest('li');
            if (li) {
                ul.removeChild(li);
                updateTotals(); // Recalculate totals after removal
            }
        }

        /**
        * Termina la edici√≥n de un elemento, eliminando el atributo contenteditable.
        * @param {HTMLElement} element - El elemento que se acaba de editar (detail o cost).
        */
        function finishEditing(element) {
            if (!isEditing) {
                element.setAttribute('contenteditable', 'false');
            }
            if (element.classList.contains('cost')) {
                updateTotals();
            }
        }

        /**
         * Calcula el costo total y el monto del dep√≥sito del 50%.
         */
        function updateTotals() {
            const costElements = document.querySelectorAll('.item-row.sub .cost');
            let total = 0;

            costElements.forEach(costEl => {
                // Extract number, remove non-digit/non-decimal characters (like $, space, comma)
                const text = costEl.textContent.replace(/[$.]/g, '');
                const value = parseFloat(text.replace(',', '.')); 

                if (!isNaN(value)) {
                    total += value;
                }
                
                // Vuelve a formatear el costo en la celda si estamos editando
                if (isEditing) {
                    costEl.textContent = `$ ${value.toLocaleString('es-AR', { minimumFractionDigits: 0 })}`;
                }
            });

            // Calculate deposit
            const deposit = total * 0.50;

            // Formato de n√∫meros con separador de miles
            const totalFormatted = total.toLocaleString('es-AR', { minimumFractionDigits: 0 });
            const depositFormatted = deposit.toLocaleString('es-AR', { minimumFractionDigits: 0 });

            // Update DOM
            document.getElementById('totalAmount').innerHTML = `$${totalFormatted}<span class="ars">ARS</span>`;
            document.getElementById('depositAmount').textContent = `$${depositFormatted}`;
        }
    </script>
</body>

</html>